<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محرر تصميم - صفحة واحدة (مثل Canva)</title>
  <!-- Fabric.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
  <!-- الخطوط العربية -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic&display=swap" rel="stylesheet">


  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
    *{box-sizing:border-box;font-family:'Almarai',sans-serif}
    body{margin:0;height:100vh;background:linear-gradient(180deg,#071024 0%, #07102a 100%);color:#fff;display:flex;flex-direction:column}
    header{height:64px;display:flex;align-items:center;padding:0 16px;gap:12px;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.03)}
    header .brand{font-weight:800;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center}
    button,select,input[type="color"]{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px;border-radius:6px;cursor:pointer}
    button:hover{border-color:var(--accent)}

    .app{flex:1;display:flex;gap:12px;padding:12px}
    .left-panel,.right-panel{width:260px;background:rgba(255,255,255,0.02);border-radius:8px;padding:12px;overflow:auto}
    
    .canvas-wrap{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#0b1220;
  overflow:auto; /* يسمح بالتمرير الكامل */
  position:relative;


  flex: 1;
  overflow: auto;
  position: relative;
}

    .stage{background:#fff;border-radius:6px;box-shadow:0 8px 30px rgba(2,6,23,0.7);}
    .controls-group{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .mini{padding:6px 8px;font-size:13px}
    .panel-title{font-size:13px;color:var(--muted);margin-bottom:8px}
    .layers-list{list-style:none;padding:0;margin:0}
    .layers-list li{padding:6px;border-radius:6px;margin-bottom:6px;background:rgba(0,0,0,0.12);display:flex;justify-content:space-between;align-items:center}
    footer{height:36px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--muted)}
    input[type="range"]{width:120px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .row{display:flex;gap:8px}
    .hidden{display:none}
    
  </style>
 
</head>
<body>
  <header>
    <div class="brand">محرر التصميم الخاص بك</div>
    <div style="flex:1"></div>
    <div class="toolbar">
      <button id="undoBtn" class="mini">تراجع</button>
      <button id="redoBtn" class="mini">إعادة</button>
      <button id="exportPng" class="mini">تصدير PNG</button>
      <button id="exportSvg" class="mini">تصدير SVG</button>
      <button id="saveJson" class="mini">حفظ مشروع</button>
      <button id="loadJson" class="mini">تحميل مشروع</button>
      <input id="fileLoad" class="hidden" type="file" accept="application/json" />
    </div>
  </header>

  <div class="app">
    <aside class="left-panel">
      <div class="panel-title">عناصر</div>
      <div class="controls-group">
        <button id="addText" class="mini">إضافة نص</button>
        <button id="addImg" class="mini">إضافة صورة</button>
        <button id="addRect" class="mini">مربع</button>
        <button id="addCircle" class="mini">دائرة</button>
        <button id="addLine" class="mini">خط</button>
        <input id="imageLoader" type="file" accept="image/*" class="mini" />
      </div>

      <hr style="opacity:.06;margin:12px 0" />

      <div class="panel-title">تنسيق العنصر</div>
      <div id="propPanel">
        <label>الخط</label>
        <select id="fontFamily" class="mini">
          <option value="Almarai">Almarai</option>
          <option value="Tajawal">Tajawal</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Cairo">Cairo</option>
          <option value="Amiri">Amiri</option>
          <option value="Noto Kufi Arabic">Noto Kufi Arabic</option>
 
 
        </select>
        <label>حجم الخط</label>
        <input id="fontSize" type="number" value="36" min="6" class="mini" />
        <label>نص</label>
        <input id="textString" type="text" class="mini" placeholder="نص العنصر" />
        <label>لون/تعبئة</label>
        <input id="fillColor" type="color" value="#000000" />
        <label>التفاف/حجم</label>
        <div class="row" style="margin-top:6px">
          <label style="width:100%">الشفافية</label>
          <input id="opacity" type="range" min="0" max="1" step="0.01" value="1" />
        </div>
        <div style="margin-top:8px" class="row">
          <button id="bringForward" class="mini">+أعلى</button>
          <button id="sendBackward" class="mini">-أسفل</button>
          <button id="flipX" class="mini">انعكاس</button>
        </div>
        <div style="margin-top:8px" class="row">
          <button id="duplicate" class="mini">تكرار</button>
          <button id="deleteObj" class="mini">حذف</button>
        </div>
      </div>

      <hr style="opacity:.06;margin:12px 0" />

      <div class="panel-title">الطبقات</div>
      <ul id="layers" class="layers-list"></ul>

    </aside>

    <div class="canvas-wrap">
      <div class="stage" id="canvasContainer" style="width:1000px;height:600px;">
        <canvas id="c"  width="1000" height="600"></canvas>
      </div>
    </div>

    <aside class="right-panel">
      <div class="panel-title">إعدادات الصفحة</div>
      <label>خلفية</label>
      <input id="bgColor" type="color" value="#ffffff" />
      <label>عرض</label>
      <input id="stageWidth" type="number" value="1000" class="mini" />
      <label>ارتفاع</label>
      <input id="stageHeight" type="number" value="600" class="mini" />
      <div style="margin-top:8px" class="row">
        <button id="resizeStage" class="mini">تطبيق الحجم</button>
      </div>

      <hr style="opacity:.06;margin:12px 0" />

      <div class="panel-title">عرض & تكبير</div>
      <label>تكبير / تصغير</label>
      <input id="zoomRange" type="range" min="0.2" max="2" step="0.05" value="1" />

      <hr style="opacity:.06;margin:12px 0" />

      <div class="panel-title">محاكاة الشبكة</div>
      <label>إظهار شبكة</label>
      <input id="toggleGrid" type="checkbox" />
      <label>حجم شبكة (px)</label>
      <input id="gridSize" type="number" value="20" class="mini" />

      <hr style="opacity:.06;margin:12px 0" />

      <div class="panel-title">المساعدة السريعة</div>
      <ul>
        <li>اختر عنصر لتحرير خصائصه.</li>
        <li>اسحب لتغيير الحجم أو للتدوير استخدم النقطة فوق العنصر.</li>
        <li>احفظ المشروع JSON ثم أعد تحميله لاحقًا.</li>
      </ul>
    </aside>
  </div>

  <footer>مُنشأ بواسطة محرر تجريبي — يمكنك تعديل الكود لاضافة مزايا إضافية</footer>

  <script>
    // إعداد كانفاس باستخدام Fabric.js
    const canvas = new fabric.Canvas('c', { selection: true, preserveObjectStacking: true });
    canvas.backgroundColor = '#ffffff';

    // قائمة حفظ التاريخ (Undo/Redo)
    let stateHistory = [];
    let historyIndex = -1;
    function saveState() {
      historyIndex++;
      stateHistory = stateHistory.slice(0, historyIndex);
      stateHistory.push(JSON.stringify(canvas));
      // الحفاظ على طول معقول
      if (stateHistory.length > 100) stateHistory.shift();
      historyIndex = stateHistory.length - 1;
    }
    function loadState(index) {
      if (index < 0 || index >= stateHistory.length) return;
      canvas.clear();
      canvas.loadFromJSON(stateHistory[index], canvas.renderAll.bind(canvas), function(o, object) {
        // after each object loaded
      });
    }

    // نسجل أول حالة
    saveState();

    // أدوات إضافة العناصر
    document.getElementById('addText').onclick = () => {
      const txt = new fabric.IText('نص جديد', { left: 100, top: 100, fontSize: 36, fill: '#000' });
      canvas.add(txt).setActiveObject(txt);
      saveState();
      refreshLayers();
    };

    document.getElementById('addRect').onclick = () => {
      const rect = new fabric.Rect({ left: 120, top: 120, width: 200, height: 120, fill: '#f97316' });
      canvas.add(rect).setActiveObject(rect);
      saveState();refreshLayers();
    };

    document.getElementById('addCircle').onclick = () => {
      const circ = new fabric.Circle({ left: 160, top: 160, radius: 60, fill: '#06b6d4' });
      canvas.add(circ).setActiveObject(circ);
      saveState();refreshLayers();
    };

    document.getElementById('addLine').onclick = () => {
      const line = new fabric.Line([50, 100, 200, 100], { left: 150, top: 150, stroke: '#000', strokeWidth: 4 });
      canvas.add(line).setActiveObject(line);
      saveState();refreshLayers();
    };

    // رفع صورة من المستخدم
    const imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(f){
        fabric.Image.fromURL(f.target.result, function(img){
          img.set({ left: 120, top: 120, scaleX: 0.6, scaleY: 0.6 });
          canvas.add(img).setActiveObject(img);
          saveState();refreshLayers();
        });
      };
      reader.readAsDataURL(file);
      this.value = null;
    });

    // حذف وتكرار
    document.getElementById('deleteObj').onclick = () => {
      const o = canvas.getActiveObject();
      if (!o) return;
      canvas.remove(o);
      saveState();refreshLayers();
    };
    document.getElementById('duplicate').onclick = () => {
      const o = canvas.getActiveObject();
      if (!o) return;
      o.clone(function(cl){
        cl.set({ left: o.left + 20, top: o.top + 20 });
        canvas.add(cl).setActiveObject(cl);
        saveState();refreshLayers();
      });
    };

    // ترتيب الطبقات
    document.getElementById('bringForward').onclick = () => { const o=canvas.getActiveObject(); if(o){ canvas.bringForward(o); saveState(); refreshLayers(); }};
    document.getElementById('sendBackward').onclick = () => { const o=canvas.getActiveObject(); if(o){ canvas.sendBackwards(o); saveState(); refreshLayers(); }};

    // انعكاس
    document.getElementById('flipX').onclick = () => { const o=canvas.getActiveObject(); if(o){ o.toggle('flipX'); canvas.requestRenderAll(); saveState(); }};

    // خصائص النص/العنصر
    const fontFamily = document.getElementById('fontFamily');
    const fontSize = document.getElementById('fontSize');
    const textString = document.getElementById('textString');
    const fillColor = document.getElementById('fillColor');
    const opacity = document.getElementById('opacity');

    function applyPropsToActive(){
      const o = canvas.getActiveObject(); if(!o) return;
      if (o.type === 'i-text' || o.type === 'textbox' || o.type === 'text'){
        o.set({ fontFamily: fontFamily.value, fontSize: parseInt(fontSize.value,10), text: textString.value });
      }
      o.set({ fill: fillColor.value, opacity: parseFloat(opacity.value) });
      canvas.requestRenderAll();
      saveState();
      refreshLayers();
    }

    fontFamily.onchange = applyPropsToActive;
    fontSize.onchange = applyPropsToActive;
    textString.oninput = applyPropsToActive;
    fillColor.onchange = applyPropsToActive;
    opacity.oninput = applyPropsToActive;

    // اختيار عنصر يعرض خصائصه
    canvas.on('selection:created', syncProperties);
    canvas.on('selection:updated', syncProperties);
    canvas.on('selection:cleared', clearProperties);
    canvas.on('object:modified', function(){ saveState(); refreshLayers(); });

    function syncProperties(){
      const o = canvas.getActiveObject(); if(!o) return;
      fillColor.value = o.fill || '#000000';
      opacity.value = o.opacity != null ? o.opacity : 1;
      if (o.type === 'i-text' || o.type === 'textbox' || o.type === 'text'){
        fontFamily.value = o.fontFamily || 'Almarai';
        fontSize.value = o.fontSize||36;
        textString.value = o.text||'';
      } else {
        textString.value = '';
      }
    }
    function clearProperties(){ textString.value=''; }

    // تصدير
    document.getElementById('exportPng').onclick = () => {
      const dataURL = canvas.toDataURL({format:'png',multiplier:2});
      const link = document.createElement('a');
      link.href = dataURL; link.download = 'design.png'; link.click();
    };
    document.getElementById('exportSvg').onclick = () => {
      const svg = canvas.toSVG();
      const blob = new Blob([svg], {type: 'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'design.svg'; a.click();
      URL.revokeObjectURL(url);
    };

    // حفظ/تحميل JSON للمشروع
    document.getElementById('saveJson').onclick = () => {
      const json = JSON.stringify(canvas.toJSON());
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'project.json'; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById('loadJson').onclick = () => { document.getElementById('fileLoad').click(); };
    document.getElementById('fileLoad').onchange = function(e){
      const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=function(ev){
        try{ canvas.loadFromJSON(ev.target.result, canvas.renderAll.bind(canvas)); saveState(); refreshLayers(); }catch(err){ alert('خطأ في تحميل المشروع'); }
      }; r.readAsText(f); this.value=null;
    };

    // تغيير حجم المسرح
    document.getElementById('resizeStage').onclick = () => {
      const w = parseInt(document.getElementById('stageWidth').value,10) || 800;
      const h = parseInt(document.getElementById('stageHeight').value,10) || 600;
      const canvasEl = document.getElementById('c');
      canvas.setWidth(w); canvas.setHeight(h);
      document.getElementById('canvasContainer').style.width = w + 'px';
      document.getElementById('canvasContainer').style.height = h + 'px';
      canvas.calcOffset();
      canvas.requestRenderAll();
      saveState();
    };

    // Zoom
    
const stageEl = document.getElementById('canvasContainer');
const zoomInput = document.getElementById('zoomRange');




let zoomLevel = 1;
zoomInput.addEventListener('input', function() {
  zoomLevel = parseFloat(this.value);
  stageEl.style.transform = `scale(${zoomLevel})`;
  stageEl.style.transformOrigin = 'center center';
});












/*
// دعم التكبير بالماوس مثل Canva
stageEl.addEventListener('wheel', (e) => {
  e.preventDefault();
  if (e.deltaY < 0) zoomLevel += 0.1;
  else zoomLevel -= 0.1;
  zoomLevel = Math.min(Math.max(zoomLevel, 0.2), 3);
  zoomInput.value = zoomLevel.toFixed(2);
  stageEl.style.transform = `scale(${zoomLevel})`;
  stageEl.style.transformOrigin = 'center center';
});
*/




    




    // Grid
    let gridVisible = false;
    document.getElementById('toggleGrid').onchange = function(){ gridVisible = this.checked; drawGrid(); };
    document.getElementById('gridSize').onchange = drawGrid;
    function drawGrid(){
      const gridSize = parseInt(document.getElementById('gridSize').value,10) || 20;
      // نستخدم backgroundImage لعرض شبكة خفيفة
      if(!gridVisible){ canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); return; }
      const w = canvas.getWidth(), h = canvas.getHeight();
      const bg = document.createElement('canvas'); bg.width = w; bg.height = h; const ctx = bg.getContext('2d');
      ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 1;
      for(let i=0;i<w;i+=gridSize){ ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
      for(let j=0;j<h;j+=gridSize){ ctx.beginPath(); ctx.moveTo(0,j); ctx.lineTo(w,j); ctx.stroke(); }
      const data = bg.toDataURL('image/png');
      canvas.setBackgroundImage(data, canvas.renderAll.bind(canvas));
    }

    // Layers panel
    function refreshLayers(){
      const layers = document.getElementById('layers'); layers.innerHTML='';
      const objs = canvas.getObjects().slice().reverse(); // العرض من الأعلى
      objs.forEach((o, idx)=>{
        const li = document.createElement('li');
        const name = o.type === 'image' ? 'صورة' : (o.type === 'rect' ? 'مربع' : (o.type === 'circle' ? 'دائرة' : (o.type === 'i-text' ? 'نص' : o.type)));
        li.innerHTML = `<span>${name} — ${o.id||''}</span>`;
        const btns = document.createElement('div');
        const sel = document.createElement('button'); sel.className='mini'; sel.textContent='اختيار'; sel.onclick = () => { canvas.setActiveObject(o); canvas.requestRenderAll(); };
        const up = document.createElement('button'); up.className='mini'; up.textContent='▲'; up.onclick = () => { canvas.bringForward(o); saveState(); refreshLayers(); };
        const down = document.createElement('button'); down.className='mini'; down.textContent='▼'; down.onclick = () => { canvas.sendBackwards(o); saveState(); refreshLayers(); };
        btns.appendChild(sel); btns.appendChild(up); btns.appendChild(down);
        li.appendChild(btns);
        layers.appendChild(li);
      });
    }

    // Undo/Redo
    document.getElementById('undoBtn').onclick = () => { if (historyIndex > 0) { historyIndex--; loadState(historyIndex); } };
    document.getElementById('redoBtn').onclick = () => { if (historyIndex < stateHistory.length - 1) { historyIndex++; loadState(historyIndex); } };

    // حفظ الحالة على أي تغيير كبير
    canvas.on('object:added', function(){ saveState(); refreshLayers(); });
    canvas.on('object:removed', function(){ saveState(); refreshLayers(); });

    // مزايا مفيدة أخرى
    document.getElementById('addImg').onclick = () => { const url = prompt('أدخل رابط الصورة (URL)'); if(!url) return; fabric.Image.fromURL(url, function(img){ img.set({ left:100, top:100, scaleX:0.6, scaleY:0.6 }); canvas.add(img).setActiveObject(img); saveState(); refreshLayers(); }); };

    // استجابة لتغييرات الواجهة
    window.addEventListener('resize', function(){ canvas.calcOffset(); });

    // زر حذف باستخدام لوحة المفاتيح
    window.addEventListener('keydown', function(e){ if(e.key === 'Delete' || e.key === 'Backspace'){ const o = canvas.getActiveObject(); if(o){ canvas.remove(o); saveState(); refreshLayers(); } } });

    // توجيهات أخيرة: ضبط الخلفية
    document.getElementById('bgColor').onchange = function(){ canvas.setBackgroundColor(this.value, canvas.requestRenderAll.bind(canvas)); saveState(); };

    // تهيئة الواجهة
    refreshLayers();

    // Maintenance tip: this is a single-file demo. For production move to modules and add optimizations (lazy image decode, font loading, server-side saving ...)
  </script>
</body>
</html>


